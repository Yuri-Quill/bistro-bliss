import express from "express"; // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É Express –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞
import dotenv from "dotenv"; // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º dotenv –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ .env
import cors from "cors"; // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º middleware –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ CORS (–∫—Ä–æ—Å—Å-–¥–æ–º–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã)
import helmet from "helmet"; // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º Helmet –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ HTTP –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
import cookieParser from "cookie-parser"; // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º cookie-parser –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å cookies
import morgan from "morgan"; // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º morgan –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
import compression from "compression"; // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º compression –¥–ª—è —Å–∂–∞—Ç–∏—è –æ—Ç–≤–µ—Ç–æ–≤
import rateLimit from "express-rate-limit"; // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º middleware –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ (Rate Limiting)

import { sanitizeInput } from "./Middleware/sanitizeMiddleware.js"; // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–π middleware –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
import { logger } from "./Middleware/winstonMiddleware.js"; // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º Winston –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫
import connectDB from "./Config/db.js"; // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î

import UserRoutes from "./Routes/UserRoutes.js"; // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–∞—Ä—à—Ä—É—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
import RecipeRoutes from "./Routes/RecipeRoutes.js";

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
const limit = rateLimit({
	windowMs: 15 * 60 * 1000, // –û–∫–Ω–æ –≤—Ä–µ–º–µ–Ω–∏ –≤ 15 –º–∏–Ω—É—Ç
	max: 100, // –ú–∞–∫—Å–∏–º—É–º 100 –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ 15 –º–∏–Ω—É—Ç —Å –æ–¥–Ω–æ–≥–æ IP
	message: "–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤ —Å —ç—Ç–æ–≥–æ IP, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ", // –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ, –µ—Å–ª–∏ –ª–∏–º–∏—Ç –ø—Ä–µ–≤—ã—à–µ–Ω
});

// –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ —Ñ–∞–π–ª–∞ .env
dotenv.config();

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Express
const app = express();

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ middleware
app.use(
	cors({
		origin: ["http://localhost:5137", "http://localhost:5173"],
		credentials: true,
		methods: ["GET", "POST", "PUT", "DELETE"], // —É–∫–∞–∂–∏—Ç–µ –Ω—É–∂–Ω—ã–µ –º–µ—Ç–æ–¥—ã
	})
);

app.use(helmet()); // –ü–æ–¥–∫–ª—é—á–∞–µ–º Helmet –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∞—Ç–∞–∫ —á–µ—Ä–µ–∑ HTTP –∑–∞–≥–æ–ª–æ–≤–∫–∏
app.use(cookieParser()); // –î–ª—è —Ä–∞–±–æ—Ç—ã —Å cookies –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö
app.use(express.json({ limit: '50mb' })); // –î–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –≤ —Ç–µ–ª–µ –∑–∞–ø—Ä–æ—Å–æ–≤
app.use(express.urlencoded({ limit: '50mb', extended: true })); // –î–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ URL-–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ñ–æ—Ä–º—ã)
app.use(morgan("dev")); // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –∫–æ–Ω—Å–æ–ª—å –≤ —Ä–µ–∂–∏–º–µ "dev"
app.use(compression()); // –í–∫–ª—é—á–∞–µ–º —Å–∂–∞—Ç–∏–µ –æ—Ç–≤–µ—Ç–æ–≤ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –ø—Ä–æ–ø—É—Å–∫–Ω–æ–π —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
app.use(limit); // –ü—Ä–∏–º–µ–Ω—è–µ–º middleware –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
app.use(sanitizeInput); // –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–π middleware –¥–ª—è —Å–∞–Ω–∏—Ç–∏–∑–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ XSS –∞—Ç–∞–∫)

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
app.use((err, req, res, next) => {
	console.error('Detailed Server Error:', err);
	logger.error(err.message); // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —Å –ø–æ–º–æ—â—å—é Winston
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—à–∏–±–∫–∏
    const statusCode = err.status || 500;
    
	res.status(statusCode).json({
		message: "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ",
		error: process.env.NODE_ENV === 'development' ? err.message : null,
		stack: process.env.NODE_ENV === 'development' ? err.stack : null
	}); // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç —Å –æ—à–∏–±–∫–æ–π, –µ—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
});

// –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ MongoDB
connectDB(); // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ MongoDB

// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –º–∞—Ä—à—Ä—É—Ç–æ–≤

app.use("/api/users", UserRoutes);
app.use("/api/recipes", RecipeRoutes);

// –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
const PORT = process.env.PORT || 5000; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Ä—Ç, –ª–∏–±–æ –±–µ—Ä–µ–º –µ–≥–æ –∏–∑ .env (–µ—Å–ª–∏ –µ—Å—Ç—å), –ª–∏–±–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º 5000 –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
app.listen(PORT, () => {
	console.log(
		`üî• –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É ${PORT} (${process.env.NODE_ENV} mode)` // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä –∏ –≤—ã–≤–æ–¥–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Å—Ç–∞—Ä—Ç–µ
	);
});

/* 

–û–±—ä—è—Å–Ω–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π:

    –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è:
        –§–∞–π–ª .env –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ dotenv.config(), –∏ –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, —Ç–∞–∫–∏–µ –∫–∞–∫ MONGO_URI, JWT_SECRET, –∏ FRONTEND_URL, —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –∫–æ–¥–µ.

    –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–µ—Ä–∞ Express:
        –°–æ–∑–¥–∞–µ—Ç—Å—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Express —á–µ—Ä–µ–∑ const app = express().

    –ù–∞—Å—Ç—Ä–æ–π–∫–∞ middleware:
        CORS ‚Äî –î–ª—è —Ç–æ–≥–æ —á—Ç–æ–±—ã —Ä–∞–∑—Ä–µ—à–∏—Ç—å –∑–∞–ø—Ä–æ—Å—ã —Å –¥—Ä—É–≥–æ–≥–æ –¥–æ–º–µ–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞).
        Helmet ‚Äî –ó–∞—â–∏—â–∞–µ—Ç –æ—Ç —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—è –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ HTTP –∑–∞–≥–æ–ª–æ–≤–∫–∏.
        Cookie-parser ‚Äî –ü–æ–∑–≤–æ–ª—è–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å cookies –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö.
        Morgan ‚Äî –õ–æ–≥–∏—Ä—É–µ—Ç HTTP –∑–∞–ø—Ä–æ—Å—ã, —á—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –≤ –æ—Ç–ª–∞–¥–∫–µ.
        Compression ‚Äî –°–∂–∏–º–∞–µ—Ç –æ—Ç–≤–µ—Ç—ã —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.
        Rate Limit ‚Äî –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –æ–¥–Ω–æ–≥–æ IP, —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è.
        SanitizeInput ‚Äî –ö–∞—Å—Ç–æ–º–Ω—ã–π middleware, –∫–æ—Ç–æ—Ä—ã–π –æ—á–∏—â–∞–µ—Ç –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç –≤—Ä–µ–¥–æ–Ω–æ—Å–Ω—ã—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤ (XSS –∞—Ç–∞–∫–∏).

    –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ MongoDB:
        –ò—Å–ø–æ–ª—å–∑—É–µ–º mongoose.connect() –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö MongoDB. URI –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –±–µ—Ä–µ—Ç—Å—è –∏–∑ .env.

    –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞:
        –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –º–∞—Ä—à—Ä—É—Ç–∞ "/", –∫–æ—Ç–æ—Ä—ã–π –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ API —Ä–∞–±–æ—Ç–∞–µ—Ç.

    –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞:
        –° –ø–æ–º–æ—â—å—é app.listen(PORT) —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∞ –ø–æ—Ä—Ç—É, –∫–æ—Ç–æ—Ä—ã–π —Ç–∞–∫–∂–µ –±–µ—Ä–µ—Ç—Å—è –∏–∑ .env, –ª–∏–±–æ –Ω–∞ –ø–æ—Ä—Ç—É 5000 –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.

*/
